## 1. 前提・方針

### データ運用の前提（重要）

- 株主優待の受付は「1回のキャンペーンごと」に行うが、
- 本システムでは **履歴・年度管理は行わず**、以下の運用とする：

> 新しい優待を始めるたびに  
> **DB のデータ（株主・商品・申込など）は運用側でリセット（削除）し、  
> 新しい CSV を取り込んで使う。**

- そのため、**優待年度や年度コード（CampaignId, CampaignCode 等）は一切持たない。**
- 常に「今実施中の優待」のデータだけを扱うシステムとする。

### 技術スタック

- フロントエンド：C# Blazor WebAssembly
- バックエンド：ASP.NET Core Web API（.NET 最新 LTS、例：.NET 8）
- 認証・認可：ASP.NET Core Identity（管理者・株主共通）
- DB：SQL Server（Entity Framework Core）
- ログ：Serilog（最低限ファイル出力）

### ソリューション構成（株主・管理を完全分離）

サーバ／クライアントとも、株主用と管理用を分離してください。

```text
RootSolution/
  Shareholder/   … 株主向け ASP.NET Core Web API
                        （Identity, EF Core, Serilog, 株主用 API）
  Admin/         … 管理者向け ASP.NET Core Web API
                        （Identity, EF Core, Serilog, 管理用 API）
  ShareholderClient/   … 株主向け Blazor WebAssembly
  AdminClient/         … 管理者向け Blazor WebAssembly
  Shared/              … 共通 DTO / モデル / 定数 等
````

* 両サーバーは別プロセスの Web API。
* **DB は 1 つを共有**（Identity テーブルも共通）。
* ShareholderClient → ShareholderServer のみアクセス。
* AdminClient → AdminServer のみアクセス。

## 2. システム概要

目的：

* 株主優待申込をハガキから Web に移行し、

  * 事務作業の効率化（手入力廃止）
  * 印刷費・郵送費の削減
    を実現する。

範囲：

* Web 上での株主優待申込受付
* 申込データの CSV 出力（既存システム・発送業者向け）

利用者：

* 株主（ロール `User`）
* 管理者（ロール `Admin`。必要なら `Operator` 等）

申込期間：

* 設定ファイルまたはテーブルで保持する **開始日・終了日** により制御（年度ではなく、単純な期間）。
* 例：M_SystemConfig のようなテーブルで Key/Value 管理してもよい。

## 3. DB 設計（論理・Identity 連携）

EF Core のエンティティは Shared プロジェクトに定義し、ShareholderServer / AdminServer の両方から共通利用してください。
Identity は標準スキーマ（AspNetUsers など）を利用し、同じ DB に配置します。

### 3.1 株主マスタ（M_Shareholder）

* ShareholderId (int, PK)
* UserId (string, FK → AspNetUsers.Id) … Identity ユーザ ID
* ShareholderNo (string) … 株主番号（ユニーク）
* ShareholderName (string)
* ShareholderNameKana (string?)
* PostalCode (string)
* Address1 (string)
* Address2 (string)
* Address3 (string?)
* PhoneNumber (string?)
* Holdings (int)
* CourseCode (string?) … 将来コース制を併用する場合用
* GrantedPoints (int) … 付与ポイント
* UsedPoints (int) … 使用済ポイント
* IsActive (bool)
* CreatedAt (DateTime)
* UpdatedAt (DateTime)

※ 使用可能ポイント = GrantedPoints − UsedPoints

### 3.2 優待商品マスタ（M_RewardItem）

* ItemId (int, PK)
* ItemCode (string) … ユニーク
* ItemName (string)
* ItemDescription (string?)
* RequiredPoints (int) … 1 単位あたり必要ポイント
* DisplayOrder (int)
* IsActive (bool)
* CreatedAt (DateTime)
* UpdatedAt (DateTime)

### 3.3 申込ヘッダ（T_RewardOrder）

* OrderId (int, PK)
* ShareholderId (int, FK → M_Shareholder)
* TotalPoints (int)
* OrderedAt (DateTime)
* IsCancelled (bool)
* IsExported (bool) … CSV 出力済みフラグ
* CreatedAt (DateTime)
* UpdatedAt (DateTime)

### 3.4 申込明細（T_RewardOrderItem）

* OrderItemId (int, PK)
* OrderId (int, FK → T_RewardOrder)
* ItemId (int, FK → M_RewardItem)
* Quantity (int)
* SubtotalPoints (int) … RequiredPoints × Quantity

### 3.5 株主 CSV インポート履歴（T_ImportBatch）

* ImportId (int, PK)
* ExecutedAt (DateTime)
* SuccessCount (int)
* ErrorCount (int)
* FileName (string)
* AdminUserId (string, FK → AspNetUsers.Id)
* Remarks (string?)

### 3.6 システム設定（M_SystemConfig：任意）

申込期間などの設定を持たせる場合：

* ConfigKey (string, PK) 例：`ApplicationStartDate`, `ApplicationEndDate`
* ConfigValue (string)
* UpdatedAt (DateTime)

※ 必須ではないが、実装しておくと便利。

### 3.7 Identity

* AspNetUsers / AspNetRoles / AspNetUserRoles など標準テーブル。
* ロール：

  * 株主：`User`
  * 管理者：`Admin`

株主ユーザは CSV 取込時に自動作成、管理者ユーザはシードや手動で作成。

## 4. 認証・認可

### 4.1 共通

* ShareholderServer / AdminServer とも ASP.NET Core Identity + JWT を使用。
* ロールベース認可：

  * ShareholderServer：ロール `User` のみ利用。
  * AdminServer：ロール `Admin` のみ利用。

### 4.2 株主 CSV インポート時の Identity 連携（AdminServer 側）

AdminServer に、株主 CSV 取込機能を実装してください。

1 行ごとに：

1. CSV の LoginId を Identity.UserName として、新規ユーザを作成

   * Email はダミー可（例：`{ShareholderNo}@example.local`）
   * Password は InitialPassword を使用（Identity API でハッシュ化）
   * ロール `User` を付与
2. 作成したユーザ Id を UserId として M_Shareholder に登録
3. 残りの項目（株主番号・住所・ポイントなど）も M_Shareholder に保存

既に同一 ShareholderNo が存在する場合は「エラー」として扱ってよい（重複登録防止）。

### 4.3 管理者（AdminServer 用）

* Admin ロールのユーザをシードコードで生成。
* AdminClient は AdminServer の /api/auth/login を叩き、JWT を取得。

## 5. CSV 仕様

### 5.1 共通

* 文字コード：UTF-8（BOM）
* 区切り：カンマ
* 囲み文字：ダブルクォート（必要時）
* 改行：CRLF
* 1 行目：ヘッダあり

### 5.2 株主インポート CSV（株主名簿システム → AdminServer）

* 用途：株主名簿 CSV から Identity ユーザ＋M_Shareholder を登録。
* 単位：1 行 = 1 株主
* ファイル名例：`Shareholders.csv`（年度コードは付けなくてよい）

列仕様（ヘッダ名固定）：

* ShareholderNo (必須)
* ShareholderName (必須)
* ShareholderNameKana (任意)
* PostalCode (必須)
* Address1 (必須)
* Address2 (必須)
* Address3 (任意)
* PhoneNumber (任意)
* Holdings (必須, 数値)
* CourseCode (任意)
* GrantedPoints (必須, 数値)
* LoginId (必須) … Identity.UserName
* InitialPassword (必須) … Identity パスワード

※ CampaignCode は **ありません**。

### 5.3 申込エクスポート CSV（ShareholderServer → 既存システム／発送業者）

* 用途：優待申込データを既存システムや発送業者に渡す。
* 単位：1 行 = 1 株主・1 商品
* ファイル名例：`RewardOrders_Export_YYYYMMDD.csv`

列仕様：

* OrderId
* ShareholderNo
* ShareholderName
* PostalCode
* Address1
* Address2
* Address3
* PhoneNumber
* ItemCode
* ItemName
* Quantity
* RequiredPoints
* SubtotalPoints
* TotalOrderPoints
* OrderedAt (`yyyy-MM-dd HH:mm:ss` など)
* Remarks

※ CampaignCode など年度に絡む項目は持たない。

## 6. API 設計（概要）

### 6.1 ShareholderServer（株主用）

* 認証：Identity + JWT（ロール `User`）

エンドポイント例：

1. POST /api/auth/login

   * 入力：LoginId, Password
   * 処理：Identity 認証 → ロール `User` の JWT 発行。

2. GET /api/shareholder/summary

   * ログイン中の株主情報（M_Shareholder）とポイント情報。
   * 申込期間も SystemConfig などから取得して返す。

3. GET /api/shareholder/items

   * M_RewardItem のうち IsActive = true の一覧。

4. POST /api/shareholder/order

   * 入力：ItemId & Quantity のリスト
   * バリデーション：

     * Σ(Quantity×RequiredPoints) ≤ 使用可能ポイント
     * すでに Order が存在する場合はエラー（再申込不可）という仕様で実装。

5. GET /api/shareholder/order

   * ログイン中株主の申込内容（あれば）。

6. GET /api/admin/orders/export

   * ※ これは AdminServer 側に実装するため、ShareholderServer には不要。

### 6.2 AdminServer（管理用）

* 認証：Identity + JWT（ロール `Admin`）

エンドポイント例：

1. POST /api/auth/login

   * 管理者ログイン（ロール `Admin`）。

2. POST /api/admin/shareholders/import

   * 株主 CSV アップロード → Identity + M_Shareholder 登録。

3. GET/POST/PUT /api/admin/items

   * 優待商品マスタ管理。

4. GET /api/admin/orders

   * 申込一覧検索（期間、株主番号、氏名などでフィルタ）。

5. GET /api/admin/orders/export

   * 申込 CSV ダウンロード。

6. GET/PUT /api/admin/settings

   * 申込開始日・終了日などの設定を取得／更新（SystemConfig 等を利用する場合）。

## 7. Blazor WASM フロント

### 7.1 ShareholderClient

* /login
  → ShareholderServer の /api/auth/login を呼び出し、JWT を取得。

* /
  → 株主トップ（株主名・株主番号・付与ポイント・使用済／使用可能ポイント・申込期間）。

* /items
  → 優待商品一覧・数量入力。
  合計ポイントを画面上で計算し、使用可能ポイントを超えたらエラー表示またはボタン非活性。

* /confirm
  → 申込内容確認・同意チェック。

* /complete
  → 完了画面（OrderId 表示）。

### 7.2 AdminClient

* /login
  → AdminServer の /api/auth/login。

* /shareholders/import
  → 株主 CSV アップロード画面（ファイル選択→送信→結果件数表示）。

* /items
  → 優待商品マスタ一覧／編集画面。

* /orders
  → 申込一覧検索画面。

* /orders/export
  → 条件指定→CSV ダウンロード画面。

* /settings（任意）
  → 申込期間などの設定画面。

## 8. ポイント制ロジック

* 使用可能ポイント = GrantedPoints − UsedPoints
* 申込登録時：

  * ログイン中株主の M_Shareholder を取得。
  * 選択された ItemId & Quantity から合計ポイントを計算。
  * 合計ポイント ≤ 使用可能ポイント の場合のみ T_RewardOrder / T_RewardOrderItem を登録。
  * UsedPoints を更新（または Order から集計でもよいが、今回は UsedPoints 更新でよい）。

## 9. ログ（Serilog）

* ShareholderServer / AdminServer 両方に Serilog を導入。
* ログ出力例：

  * ログイン成功／失敗（ユーザ名、ロール）
  * 株主 CSV インポート開始・終了・結果件数（AdminServer）
  * 申込 CSV エクスポート（AdminServer）
  * 申込登録（ShareholderServer, OrderId, ShareholderId）
  * 例外は Error レベルでスタックトレース付き。

## 10. 実装リクエスト

上記仕様に従い、

* 5 プロジェクト構成（ShareholderServer, AdminServer, ShareholderClient, AdminClient, Shared）
* 共通 DB スキーマ（EF Core モデル・マイグレーション）
* Identity 設定（ロール：User / Admin）
* ShareholderServer / AdminServer それぞれの API 実装
* 株主向け／管理者向け Blazor WASM UI
* Serilog 設定

を含むコードを提案・生成してください。

特に、

* 「優待年度やキャンペーン ID は一切持たない（毎回 DB をリセットする前提）」
* 「サーバー側も株主用と管理用で完全に別プロジェクト」
* 「DB と Identity テーブルは共通で利用」

という前提を必ず守ってください。
